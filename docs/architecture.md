# 数据库系统架构设计方案

## 1. 核心设计原则

- **模块化**: 清晰划分模块，降低耦合度，提高可维护性和可扩展性。
- **简洁性**: 初期专注于核心功能，避免过度设计。
- **可测试性**: 设计应易于进行单元测试和集成测试。
- **持久化**: 数据需要可靠地存储到磁盘。
- **版本控制**: 支持数据快照/版本控制以实现回退功能。

## 2. 模块划分

系统将主要包含以下模块：

1.  **API 模块 (APIMgr)**:

    - **职责**: 提供外部接口，供应用程序与数据库交互。初期将设计为嵌入式库 API。
    - **接口 (Rust Traits/Functions)**:
      - `connect()`: 连接到数据库。
      - `disconnect()`: 断开连接。
      - `begin_transaction()`: 开始一个新的事务。
      - `commit_transaction()`: 提交当前事务。
      - `rollback_transaction()`: 回滚当前事务。
      - `put(key, value)`: 存储键值对。
      - `get(key)`: 根据键检索值。
      - `delete(key)`: 删除键值对。
      - `create_snapshot(snapshot_id)`: 创建数据快照。
      - `restore_snapshot(snapshot_id)`: 恢复到指定快照。
      - (预留) `execute_query(query_string)`: 执行查询语句。
    - **交互**: 与事务管理模块和查询处理模块（预留）交互。

2.  **事务管理模块 (TxnMgr)**:

    - **职责**: 管理事务的生命周期，确保 ACID 属性（初期可能简化，逐步完善）。处理事务的开始、提交和回滚。协调存储引擎进行实际的数据操作。
    - **接口**:
      - `begin()`: 开始一个新事务，返回事务 ID。
      - `commit(transaction_id)`: 提交指定事务。
      - `rollback(transaction_id)`: 回滚指定事务。
      - `read(transaction_id, key)`: 在事务上下文中读取数据。
      - `write(transaction_id, key, value)`: 在事务上下文中写入数据。
      - `delete(transaction_id, key)`: 在事务上下文中删除数据。
    - **交互**: 与存储引擎模块交互，执行实际的数据读写。与日志模块（隐含）交互记录事务操作。

3.  **存储引擎模块 (StorageEngine)**:

    - **职责**: 负责数据的实际存储和检索。管理数据在磁盘上的布局和持久化。实现数据快照/版本控制机制。
    - **接口**:
      - `read_data(key, version)`: 读取指定版本的数据。如果 `version` 未指定或为最新，则读取最新数据。
      - `write_data(key, value)`: 写入数据，并处理版本控制（例如，写时复制 Copy-on-Write）。
      - `delete_data(key)`: 标记删除或实际删除数据。
      - `snapshot(snapshot_id)`: 创建数据快照的逻辑。
      - `restore(snapshot_id)`: 从快照恢复数据的逻辑。
      - `load_from_disk()`: 系统启动时从磁盘加载数据。
      - `flush_to_disk()`: 将内存中的更改刷新到磁盘。
    - **交互**: 直接与文件系统交互进行数据的持久化。被事务管理模块调用。

4.  **查询处理模块 (QueryProcessor) - 预留**:

    - **职责**: 解析和执行查询语句（例如 SQL 或其他自定义查询语言）。优化查询计划。
    - **接口 (预留)**:
      - `parse(query_string)`: 解析查询字符串。
      - `optimize(parsed_query)`: 优化查询计划。
      - `execute(optimized_query, transaction_id)`: 在指定事务上下文中执行查询。
    - **交互 (预留)**: 与事务管理模块交互以在事务上下文中读写数据。

5.  **日志模块 (LogMgr) - 隐含但重要**:
    - **职责**: 记录所有对数据库状态产生更改的操作，用于崩溃恢复和可能的事务回滚（如果采用预写日志 WAL 等技术）。对于数据快照/版本控制，日志也可能记录元数据变更。
    - **接口**:
      - `log_operation(transaction_id, operation_type, data)`: 记录操作。
      - `recover()`: 系统启动时进行恢复。
    - **交互**: 被事务管理模块和存储引擎模块调用。

## 3. 模块交互图 (Mermaid)

```mermaid
graph TD
    A[应用程序] -->|调用 API| B(API 模块 API_Mgr);

    B -->|事务请求| C(事务管理模块 Txn_Mgr);
    B -->|查询请求 (预留)| D(查询处理模块 Query_Processor);

    C -->|数据操作请求| E(存储引擎模块 Storage_Engine);
    C -->|记录事务日志| F(日志模块 Log_Mgr);

    D -->|数据访问 (预留)| C;

    E -->|读写磁盘| G[物理存储/文件系统];
    E -->|记录数据变更日志| F;
```

## 4. 数据持久化与快照/版本控制初步思路

- **持久化**: 存储引擎将负责将数据写入磁盘。可以考虑使用简单的键值存储文件格式（如 SSTable 类似结构，或者更简单的日志结构文件系统 LSM-tree 的简化版），或者直接使用二进制文件格式。
- **快照/版本控制**:
  - 可以采用**写时复制 (Copy-on-Write, COW)** 的策略。当数据被修改时，不是直接在原地修改，而是创建一个新的版本。旧版本数据保持不变，直到没有事务或快照引用它。
  - 快照可以被实现为指向特定数据版本集合的引用。
  - 元数据需要管理哪些版本构成了哪个快照。

## 5. [`src/main.rs`](src/main.rs) 中的基本测试思路

在 [`src/main.rs`](src/main.rs) 中，我们可以编写一些集成测试用例来验证核心功能的正确性：

1.  **基本存储和检索测试**:
    - 连接数据库。
    - `put` 一个键值对。
    - `get` 该键值对，验证其正确性。
    - `delete` 该键值对。
    - `get` 已删除的键，验证其不存在。
2.  **事务处理测试**:
    - 开始一个事务。
    - 在事务中 `put` 多个键值对。
    - `commit` 事务。
    - 验证提交后的数据可见。
    - 开始另一个事务。
    - 在事务中 `put` 数据，然后 `rollback` 事务。
    - 验证回滚后的数据未被修改。
3.  **数据快照/版本控制测试**:
    - `put` 一些初始数据。
    - `create_snapshot("snap1")`。
    - 修改一些数据。
    - `restore_snapshot("snap1")`。
    - 验证数据已恢复到快照 "snap1" 的状态。
    - 再次修改数据。
    - `put` 新数据。
    - `create_snapshot("snap2")`。
    - 验证可以恢复到 "snap1" 或 "snap2"。

这些测试将通过调用 API 模块提供的接口来完成。
